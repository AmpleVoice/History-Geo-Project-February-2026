// Prisma Schema for Algerian History Map Application
// خريطة المقاومات الشعبية الجزائرية

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

enum EventType {
  REVOLUTION  // ثورة
  UPRISING    // انتفاضة
  BATTLE      // معركة
  SIEGE       // حصار
  RESISTANCE  // مقاومة
  RAID        // غزوة
}

enum ReviewStatus {
  CONFIRMED     // مؤكد
  NEEDS_REVIEW  // بحاجة_لمراجعة
  UNVERIFIED    // غير_مؤكد
  DRAFT         // مسودة
}

enum SourceType {
  BOOK          // كتاب
  ARTICLE       // مقال
  ARCHIVE       // أرشيف
  ENCYCLOPEDIA  // موسوعة
  THESIS        // رسالة
  WEBSITE       // موقع
  DOCUMENT      // وثيقة
}

enum UserRole {
  VIEWER
  EDITOR
  ADMIN
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
}

// ============================================
// Models
// ============================================

model Region {
  id        String   @id @default(uuid())
  nameAr    String   @map("name_ar")
  nameEn    String?  @map("name_en")
  code      String   @unique
  geometry  Json?    // GeoJSON geometry
  centerLat Float?   @map("center_lat")
  centerLng Float?   @map("center_lng")
  parentId  String?  @map("parent_id")
  parent    Region?  @relation("RegionHierarchy", fields: [parentId], references: [id])
  children  Region[] @relation("RegionHierarchy")
  events    Event[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("regions")
}

model Event {
  id                  String       @id @default(uuid())
  title               String
  type                EventType
  regionId            String       @map("region_id")
  region              Region       @relation(fields: [regionId], references: [id])
  startDate           DateTime     @map("start_date")
  endDate             DateTime?    @map("end_date")
  description         String
  detailedDescription String?      @map("detailed_description")
  coordinates         Json?        // {lat, lng}
  outcome             String?
  casualtiesText      String?      @map("casualties_text")
  casualtiesEstimated Int?         @map("casualties_estimated")
  parties             Json?        // {resistance: [], colonial: [], other: []}
  reviewStatus        ReviewStatus @default(DRAFT) @map("review_status")

  // Relations
  people       EventPerson[]
  sources      EventSource[]
  tags         EventTag[]

  // Audit
  createdById  String       @map("created_by_id")
  createdBy    User         @relation("EventCreatedBy", fields: [createdById], references: [id])
  updatedById  String?      @map("updated_by_id")
  updatedBy    User?        @relation("EventUpdatedBy", fields: [updatedById], references: [id])
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@index([regionId])
  @@index([type])
  @@index([startDate])
  @@index([reviewStatus])
  @@map("events")
}

model Person {
  id        String        @id @default(uuid())
  nameAr    String        @map("name_ar")
  nameEn    String?       @map("name_en")
  birthYear Int?          @map("birth_year")
  deathYear Int?          @map("death_year")
  bio       String?
  role      String?       // General role (e.g., قائد، شيخ)
  imageUrl  String?       @map("image_url")
  events    EventPerson[]
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  @@index([nameAr])
  @@map("people")
}

model EventPerson {
  eventId  String @map("event_id")
  event    Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  personId String @map("person_id")
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  role     String // Role in this specific event
  notes    String?

  @@id([eventId, personId])
  @@map("event_people")
}

model Source {
  id        String        @id @default(uuid())
  title     String
  author    String?
  year      Int?
  publisher String?
  type      SourceType
  url       String?
  isbn      String?
  notes     String?
  events    EventSource[]
  createdAt DateTime      @default(now()) @map("created_at")

  @@index([title])
  @@index([author])
  @@map("sources")
}

model EventSource {
  eventId   String  @map("event_id")
  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sourceId  String  @map("source_id")
  source    Source  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  pageRange String? @map("page_range")
  quote     String?
  notes     String?

  @@id([eventId, sourceId])
  @@map("event_sources")
}

model Tag {
  id       String     @id @default(uuid())
  nameAr   String     @unique @map("name_ar")
  nameEn   String?    @map("name_en")
  category String?
  events   EventTag[]

  @@map("tags")
}

model EventTag {
  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tagId   String @map("tag_id")
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([eventId, tagId])
  @@map("event_tags")
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  passwordHash  String     @map("password_hash")
  name          String
  role          UserRole   @default(VIEWER)
  active        Boolean    @default(true)
  lastLogin     DateTime?  @map("last_login")
  createdEvents Event[]    @relation("EventCreatedBy")
  updatedEvents Event[]    @relation("EventUpdatedBy")
  auditLogs     AuditLog[]
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  @@map("users")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String      @map("user_id")
  user       User        @relation(fields: [userId], references: [id])
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  action     AuditAction
  oldData    Json?       @map("old_data")
  newData    Json?       @map("new_data")
  ipAddress  String?     @map("ip_address")
  timestamp  DateTime    @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}
